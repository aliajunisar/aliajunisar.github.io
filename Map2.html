<!DOCTYPE html>
<html>
    <head>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
        <script src="https://unpkg.com/maplibre-gl@^5.11.0/dist/maplibre-gl.js"></script>
        <link href="https://unpkg.com/maplibre-gl@^5.11.0/dist/maplibre-gl.css" rel="stylesheet" />
        <meta charset="UTF-8"/>
        <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title> Satonda GIS | Final Project MAPID Academy WebGIS Development </title>
    </head>
    
    <body style="margin: 0; font-family: Montserrat, sans-serif; line-height: 0.5">
        <!-- Navbar -->
        <nav
            class="flex justify-between items-center max-w-screen bg-[#1A3D64] text-[#F4F4F4]"
            style="padding: 20px 5%;">
            <h2 class="font-bold">Satonda GIS</h2>
            <ul class="flex gap-[30px] m-0 p-0 text-[#F4F4F4] font-bold">
                <li><a href="Home.html" class="hover:text-rose-400">Home</a></li>
                <li><a href="Map2.html" class="hover:text-rose-400">Map</a></li>
                <li><a href="About Me.html" class="hover:text-rose-400">About Me</a></li>
            </ul>
        </nav>

        <!-- Content: map + right sidebar -->
        <div style="display:flex; gap:0; height: 100%; width:100%; margin:0; padding:0; box-sizing: border-box; align-items: stretch;">
            <!-- map container -->
            <div id="map" style="flex: 1; min-width: 0;"></div>

            <!-- right sidebar for processing tools -->
            <aside aria-label="Processing tools" style="width: 320px; max-width: 40%; background: rgba(255,255,255,0.95); box-shadow: 0 2px 8px rgba(0,0,0,0.15); border-radius: 0 0 0 0; padding: 16px; overflow: hidden; box-sizing: border-box;">
                <h3 style="margin:0 0 18px 0; font-size:24px;"><strong>Processing Tools</strong></h3>

                <button id="btn-kls-2017" class="block w-full mb-2 px-2.5 py-3 font-sans bg-[#1D546C] text-[#f4f4f4] border-none rounded cursor-pointer text-left hover:bg-[#C70036]">2017 Benthic Classification</button>
                <button id="btn-kls-2018" class="block w-full mb-2 px-2.5 py-3 font-sans bg-[#1D546C] text-[#f4f4f4] border-none rounded cursor-pointer text-left hover:bg-[#C70036]">2018 Benthic Classification</button>
                <button id="btn-kls-2019" class="block w-full mb-2 px-2.5 py-3 font-sans bg-[#1D546C] text-[#f4f4f4] border-none rounded cursor-pointer text-left hover:bg-[#C70036]">2019 Benthic Classification</button>
                <button id="btn-kls-2020" class="block w-full mb-2 px-2.5 py-3 font-sans bg-[#1D546C] text-[#f4f4f4] border-none rounded cursor-pointer text-left hover:bg-[#C70036]">2020 Benthic Classification</button>
                <button id="btn-kls-2021" class="block w-full mb-2 px-2.5 py-3 font-sans bg-[#1D546C] text-[#f4f4f4] border-none rounded cursor-pointer text-left hover:bg-[#C70036]">2021 Benthic Classification</button>
                <button id="btn-kls-2022" class="block w-full mb-2 px-2.5 py-3 font-sans bg-[#1D546C] text-[#f4f4f4] border-none rounded cursor-pointer text-left hover:bg-[#C70036]">2022 Benthic Classification</button>
                <button id="btn-kls-2023" class="block w-full mb-2 px-2.5 py-3 font-sans bg-[#1D546C] text-[#f4f4f4] border-none rounded cursor-pointer text-left hover:bg-[#C70036]">2023 Benthic Classification</button>

                <hr style="border:none; border-top:1px solid #eee; margin:18px 0;">

                <div id="tool-log" style="font-size:13px; color:#333; margin-top:8px; white-space:pre-wrap;">Ready.</div>

                <!-- Legend box (Tailwind-style) -->
                <div id="legend" class="mt-4 bg-white rounded shadow p-3 text-sm">
                    <h4 class="font-semibold mb-2">Legend</h4>
                    <div id="legend-items" class="space-y-2">
                        <!-- populated by JS -->
                    </div>
                </div>
            </aside>
        </div>

        <script>
            const MAP_SERVICE_KEY = "67acaad1aeee190e01e20459";
            const map = new maplibregl.Map({
                style: `https://basemap.mapid.io/styles/street-new-generation/style.json?key=${MAP_SERVICE_KEY}`,
                center: [117.7481928, -8.1090344],
                zoom: 13,
                pitch: 0,
                bearing: 0,
                container: "map",
                canvasContextAttributes: { antialias: true },
                attributionControl: true,
            });

            function fetchJSON(url) {
                return fetch(url)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);
                        }
                        return response.json();
                    })
                    .catch(function(error) {
                        console.error(`Error fetching ${url}:`, error);
                        throw error;
                    });
            }

            // Fetch GeoJSON data for each year
            const dataURLs = {
                2017: './geojson/klasifikasi_2017.geojson',
                2018: './geojson/klasifikasi_2018.geojson',
                2019: './geojson/klasifikasi_2019.geojson',
                2020: './geojson/klasifikasi_2020.geojson',
                2021: './geojson/klasifikasi_2021.geojson',
                2022: './geojson/klasifikasi_2022.geojson',
                2023: './geojson/klasifikasi_2023.geojson',
            };

            // Color mapping for different class types
            const classColors = {
                'Karang': '#ff6b6b',
                'Pasir': '#ffcf00',
                'Pecahan Karang': '#707f80',
                'Lamun': '#00de33',
            };

            // Translation mapping: Indonesian -> English
            const classLabels = {
                'Karang': 'Coral',
                'Pasir': 'Sand',
                'Pecahan Karang': 'Rubble',
                'Lamun': 'Seagrass',
            };

            // track current source & layers so we can remove them cleanly
            let currentSrcId = null;
            let currentLayerIds = [];

            const sanitizeId = (s) => String(s).replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-_]/g, '').toLowerCase();

            map.on("load", () => {
                console.log("Map loaded");

                // Function to handle button clicks
                const handleButtonClick = async (year) => {
                    const logEl = document.getElementById('tool-log');
                    logEl.textContent = `Loading data for ${year} classification ...`;

                    try {
                        // Fetch the data when button is clicked
                        const geoData = await fetchJSON(dataURLs[year]);
                        const srcId = `kls-src`; // reuse same source id each time
                        const layerPrefix = `kls-layer-${year}-`; // used for new layers

                        // 1) remove previous layers (must remove layers before removing source)
                        if (currentLayerIds.length) {
                            currentLayerIds.forEach(id => {
                                if (map.getLayer(id)) map.removeLayer(id);
                            });
                            currentLayerIds = [];
                        }

                        // 2) remove previous source if exists
                        if (currentSrcId && map.getSource(currentSrcId)) {
                            map.removeSource(currentSrcId);
                        }

                        // 3) add new source
                        currentSrcId = srcId;
                        map.addSource(srcId, { type: 'geojson', data: geoData });

                        // 4) create a layer for each unique Class_Type and record its id
                        const uniqueClasses = [...new Set(geoData.features.map(f => f.properties.Class_Type))];
                        uniqueClasses.forEach(classType => {
                            const safe = sanitizeId(classType);
                            const classLayerId = `${layerPrefix}${safe}`;

                            map.addLayer({
                                id: classLayerId,
                                type: 'fill',
                                source: srcId,
                                filter: ['==', ['get', 'Class_Type'], classType],
                                paint: {
                                    'fill-color': classColors[classType] || '#CCCCCC',
                                    'fill-opacity': 1,
                                    'fill-outline-color': '#000000'
                                }
                            });

                            currentLayerIds.push(classLayerId);
                        });

                        // 5) fit to data
                        const bounds = geoData.features.reduce((bbox, feature) => {
                            const coords = feature.geometry.coordinates.flat(Infinity);
                            for (let i = 0; i < coords.length; i += 2) {
                                bbox[0] = Math.min(bbox[0], coords[i]);
                                bbox[1] = Math.min(bbox[1], coords[i + 1]);
                                bbox[2] = Math.max(bbox[2], coords[i]);
                                bbox[3] = Math.max(bbox[3], coords[i + 1]);
                            }
                            return bbox;
                        }, [Infinity, Infinity, -Infinity, -Infinity]);

                        map.fitBounds([[bounds[0], bounds[1]], [bounds[2], bounds[3]]], { padding: 40 });

                        logEl.textContent = `${year} Classification has been implemented`;
                    } catch (error) {
                        console.error(error);
                        logEl.textContent = `Failed to load data for ${year}: ${error.message}`;
                    }
                };

                // Attach event listeners to buttons
                document.getElementById('btn-kls-2017').onclick = () => handleButtonClick(2017);
                document.getElementById('btn-kls-2018').onclick = () => handleButtonClick(2018);
                document.getElementById('btn-kls-2019').onclick = () => handleButtonClick(2019);
                document.getElementById('btn-kls-2020').onclick = () => handleButtonClick(2020);
                document.getElementById('btn-kls-2021').onclick = () => handleButtonClick(2021);
                document.getElementById('btn-kls-2022').onclick = () => handleButtonClick(2022);
                document.getElementById('btn-kls-2023').onclick = () => handleButtonClick(2023);
            });

            // Render legend from classColors
            function renderLegend() {
                const container = document.getElementById('legend-items');
                if (!container) return;
                container.innerHTML = '';
                Object.entries(classColors).forEach(([classType, color]) => {
                    const label = classLabels[classType] || classType; // use English if available
                    const item = document.createElement('div');
                    item.className = 'flex items-center gap-2';
                    item.innerHTML = `
                        <span class="w-4 h-4 rounded" style="background:${color}; display:inline-block;"></span>
                        <span class="text-sm">${label}</span>
                    `;
                    container.appendChild(item);
                });
            }

            map.on("load", () => {
                renderLegend();
            });
        </script>
        
         <!-- Footer -->
        <footer class="flex flex-col md:flex-row justify-center" 
            style="text-align: center; padding: 1.3%; background: #0C2B4E; color: white">
            <p>&copy; 2025 Alia Junisar Shafira. All rights reserved.</p>
        </footer>
    </body>
</html>